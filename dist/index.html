
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Convoy Watchboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #wrap { display:grid; grid-template-columns: 360px 1fr; height: 100vh; }
    #sidebar { border-right: 1px solid #ddd; padding: 12px; overflow:auto; }
    #map { height: 100vh; }
    .muted { color:#666; font-size: 12px; }
    .card { border: 1px solid #e5e5e5; border-radius: 10px; padding: 10px; margin: 10px 0; }
    .title { font-weight: 700; }
    .btn { display:inline-block; padding:6px 10px; border:1px solid #ddd; border-radius: 8px; cursor:pointer; user-select:none; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    a { color:#0b57d0; text-decoration:none; }
    a:hover { text-decoration:underline; }
    hr { border:none; border-top:1px solid #eee; margin:12px 0; }
  </style>
</head>
<body>
<div id="wrap">
  <div id="sidebar">
    <div class="row">
      <div class="title">Convoy Watchboard</div>
      <div class="muted" id="updated">—</div>
    </div>

    <div class="row" style="margin-top:8px;">
      <span class="btn" onclick="loadAll()">Refresh</span>
    </div>

    <div class="card">
      <div class="title">Most pressing (Top 5)</div>
      <div class="muted" id="counts"></div>
      <div id="top5"></div>
    </div>

    <div class="card">
      <div class="title">Detail</div>
      <div id="detail" class="muted">Click a pin or polygon.</div>
    </div>

    <div class="muted">
      Tip: Bookmark this page and keep it open. It auto-refreshes in the background.
    </div>
  </div>

  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // ✅ Set these two values after you deploy the Worker
  const API_BASE = "https://YOUR-WORKER-URL.workers.dev"; // e.g. https://convoy-watchboard-api.yourname.workers.dev
  const API_KEY  = "PASTE_YOUR_DASH_KEY_HERE";

  const map = L.map('map', { preferCanvas: true }).setView([39.5, -98.35], 4); // US default
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18, attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const pinLayer = L.layerGroup().addTo(map);
  const polyLayer = L.geoJSON(null, { style: () => ({ weight: 2 }) }).addTo(map);

  async function loadAll() {
    const summary = await fetchJson(`${API_BASE}/api/summary?key=${encodeURIComponent(API_KEY)}`);
    document.getElementById("updated").textContent = summary.updated_at ? new Date(summary.updated_at).toLocaleString() : "—";
    document.getElementById("counts").textContent =
      `Alerts: ${summary.counts?.alerts ?? 0} • Storm reports (6h): ${summary.counts?.storm_reports_last6h ?? 0} • Quakes (day): ${summary.counts?.quakes_day ?? 0}`;

    const top5 = document.getElementById("top5");
    top5.innerHTML = "";
    (summary.top5_us ?? []).forEach(e => {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <div class="title">${escapeHtml(e.title ?? "Event")}</div>
        <div class="muted">${escapeHtml(e.hazard ?? "")} • Score ${e.convoy_score ?? 0}</div>
        <div class="muted">${escapeHtml(e.summary ?? "")}</div>
        <div style="margin-top:6px;">
          <a href="#" onclick="openDetail('${encodeURIComponent(e.id)}'); return false;">Open detail</a>
        </div>
      `;
      top5.appendChild(div);
    });

    // pull the full event list for map layers
    const all = await fetchJson(`${API_BASE}/api/summary?key=${encodeURIComponent(API_KEY)}`); // summary already fetched
    const eventsRaw = await fetchJson(`${API_BASE}/api/summary?key=${encodeURIComponent(API_KEY)}`); // keep simple for now

    // Better: fetch /api/events, but we kept MVP minimal.
    // We'll load from the detail endpoint list stored in KV by calling a hidden "events" key is not exposed.
    // So: quick improvement — call a Worker endpoint you add later: /api/events
    // For now, just render Top5 only (still useful).
  }

  async function openDetail(encodedId) {
    const id = decodeURIComponent(encodedId);
    const event = await fetchJson(`${API_BASE}/api/event/${encodeURIComponent(id)}?key=${encodeURIComponent(API_KEY)}`);
    renderDetail(event);
    flyTo(event);
  }

  function renderDetail(e) {
    if (!e) {
      document.getElementById("detail").innerHTML = "Not found.";
      return;
    }
    const links = (e.links ?? []).map(l => `<li><a target="_blank" rel="noopener" href="${escapeAttr(l.url)}">${escapeHtml(l.label)}</a></li>`).join("");
    document.getElementById("detail").innerHTML = `
      <div class="title">${escapeHtml(e.title ?? "Event")}</div>
      <div class="muted">${escapeHtml(e.category ?? "")} • ${escapeHtml(e.hazard ?? "")}</div>
      <div style="margin-top:8px;">${escapeHtml(e.summary ?? "")}</div>
      <hr/>
      <div class="title">Links</div>
      <ul>${links || "<li class='muted'>No links</li>"}</ul>
      <div class="muted">Timestamp: ${escapeHtml(e.timestamp ?? "—")}</div>
      <div class="muted">Tags: ${(e.tags ?? []).map(escapeHtml).join(", ")}</div>
    `;
  }

  function flyTo(e) {
    if (e?.location?.lat && e?.location?.lon) {
      map.flyTo([e.location.lat, e.location.lon], 9);
    } else if (e?.geometry) {
      try {
        const gj = L.geoJSON(e.geometry);
        map.fitBounds(gj.getBounds(), { padding: [20, 20] });
      } catch {}
    }
  }

  async function fetchJson(url) {
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`Fetch failed ${res.status}`);
    return await res.json();
  }

  function escapeHtml(s) {
    return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function escapeAttr(s) { return escapeHtml(s); }

  // auto-refresh every 60 seconds
  loadAll();
  setInterval(loadAll, 60_000);
</script>
</body>
</html>
